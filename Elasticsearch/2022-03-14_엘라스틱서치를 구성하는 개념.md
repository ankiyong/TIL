### 엘라스틱서치를 구성하는 개념

#### 1. 기본용어

엘라스틱서치의 데이터는 인덱스, 타입, 문서, 필드 구조로 구성된다.

##### 1.1 인덱스

인덱스는 데이터 저장 공간이다. 하나의 인덱스는 하나의 타입만 가지며 하나의 물리적인 노드에 여러개의 논리적인 인덱스를 생성할 수 있다. 

엘라스틱서치를 분산 환경으로 구성하면 하나의 읻넥스가 여러 노드에 분산 저장되어 관리된다. 따라서 분산 처리에 따른 여러 이점을 누릴 수 있다. 엘라스틱서치는 인덱스 생성 시 기본적으로 5개의 프라이머리 샤드와 1개의 레플리카 샤드 세트를 생성한다. 

##### 1.2 문서

엘라스틱서치에서 데이터가 저장되는 최소 단위다. 기본적으로 JSON 포맷으로 데이터가 저장된다. DB와 비교하자면 테이블의 행이 엘라스틱서치의 문서에 해당한다고 볼 수 있다. 하나의 문서는 다수의 필드로 구성돼 있는데 각 필드는 데이터의 형태에 따라 용도에 맞는 데이터 타입을 정의해야 한다.

##### 1.3 필드

필드는 문서를 구성하기 위한 속성이라고 할 수 있다. 하나의 필드는 목적에 따라 다수의 데이터 타입을 가질 수 있다.

##### 1.4 매핑

문서의 필드와 필드의 속성을 정의하고 그에 따른 색인 방법을 정의하는 프로세스다.

#### 2. 노드의 종류

노드는 마스터노드,데이터노드,인제스트노드,코디네이팅노드로 나눠진다.

##### 2.1 마스터 노드

마스터 노드는 인덱스를 생성, 삭제하는 등 클러스터와 관련된 전반적인 작업을 담당한다. 따라서 네트워크 속도가 빠르고 지연이 없는 노드를 마스터 노드로 선정해야 한다.

만약 노드를 마스터 노드 전용으로 설정하고자 한다면 elasticsearch.yml 파일을 열고 다음과 같이 설정하면 된다.

```bash
node.master: true
node.data: false
node.ingest: false
search.remote.connect: false
```

##### 2.2 데이터 노드

데이터 노드는 문서가 실제로 저장되는 노드다. 데이터가 실제로 분산 저장되는 물리적 공간인 샤드가 배치되는 노드이기도 하다. 

만약 노드를 데이터 노드 전용으로 설정하고자 한다면 elasticsearch.yml 파일을 열고 다음과 같이 설정하면 된다.

```bash
node.master: false
node.data: true
node.ingest: false
search.remote.connect: false
```

##### 2.3 코디네이팅 노드

다른 역할은 하지 않고, 들어온 요청을 단순히 라운드로빈 방식으로 분산시켜주는 노드다. 

```bash
node.master: false
node.data: false
node.ingest: false
search.remote.connect: false
```

##### 2.4 인제스트 노드

색인에 앞서 데이터를 전처리하기 위한 노드다. 데이터 포맷을 변경하기 위해 스크립트로 전처리 파이프라인을 구성하고 실행할 수 있다. 

```bash
node.master: false
node.data: false
node.ingest: true
search.remote.connect: false
```

### 엘라스틱서치에서 제공하는 주요 API

#### 1. 인덱스 관리 API

##### 1.1 인덱스 생성

```bash
PUT movie
{
	"settings" : {
		"number_of_shards" : 3,
		"number_of_replicas" : 2
	},
	"mappings" : {
		"_doc" : {
			"properties" : {
				"field" : {"type" : "text"},
				"field" : {"type" : "text"},
				"field" : {"type" : "text"}
			}
		}
	}
}
#인덱스를 생성하고 매핑하는 기본 구조는 다음과 같다.
```

##### 1.2 인덱스 삭제

```bash
DELETE movie
```

#### 2. 문서 관리 API

문서관리 API는 실제 문서를 색인하고 조회, 수정, 삭제를 지원하는 API다. 이를 이용해 문서를 색인하고 내용을 수정하거나 삭제할 수 있다. 

문서 관리 API는 다음과 같은 세부 기능을 제공한다.

- Index API : 한 건의 문서를 색인한다.
- Get API : 한 건의 문서를 조회한다.
- Delete API : 한 건의 문서를 삭제한다.
- Update API : 한 건의 문서를 업데이트한다.

문서 관리 API는 기본적으로 한 건의 문서를 처리하기 위한 기능을 제공한다. 하지만 클러스터를 운영하다 보면 다수의 문서를 처리해야 하는 경우도 종종 발생할 것이다. 이러한 경우에 대비해 Multi-document API도 제공한다.

- Multi Get API : 다수의 문서를 조회한다.
- Bulk API : 대량의 문서를 색인한다.
- Delete By Query API : 다수의 문서를 삭제한다.
- Reindex API : 인덱스의 문서를 다시 색인한다.

##### 2.1 문서 생성

```bash
POST movie/_doc/1
{
	"name" : "asb",
	"age" : 25,
	"gender" : "male"
}
```

#### 3. 검색 API

검색 API의 사용 방식은 다음과 같이 크게 두 가지로 나뉜다.

1. http uri 형태의 파라미터를 uri에 추가해 검색하는 방법
2. RESTful API 방식인 QueryDSL을 사용해 요청 본문에 질의 내용을 추가해 검색하는 방법

2번 방식이 1번보다 제약사항이 적기 때문에 현업에서는 2번 방식을 선호한다.

```bash
POST {index명}/_search
{
	"쿼리 구문"
}

POST movie/_search
{
	"query" : {
		"term" : {"typeNm" : "장편"}
	}
}
```

쿼리 구문은 다음과 같이 여러 개의 키를 조합해 객체의 키 값으로 사용할 수 있다.

```
{
	"size" :  #몇 개의 결과를 반환할 지 결정한다(기본값 10)
	"from" :  #어느 위치부터 반환할지를 결정한다.
	"_source" : #특정 필드만 결과로 반환하고 싶을 때 사용한다.
	"sort" : #특정 필드를 기준으로 정렬한다.
			 #asc,desc로 오름차순, 내림차순 정렬을 지정할 수도 있다.
	"query" : {
			#검색될 조건을 정의한다.
	}
	"filter" : {
			#검색 결과 중 특정한 값을 다시 부여준다.
            #결과 내에서 재검색할 떄 사용하는 기능 중 하나다.
            #다만 필터를 사용ㄹ하게 되면 자동으로 score값이 정렬되지 ㅇ낳는다.
	}
}
```

#### 4. 집계 API

엘라스틱서치는 집계 API를 제공하여 각종 통계 데이터를 실시간으로 제공할 수 있다.

##### 4.1 데이터 집계

```bash
POST movie/_serach
{
	"aggs" : {
		"genre" : {
			"terms" : {
				"field" : "genreAlt"
			}
		}
	}
}
#terms 키워드를 이용해 genreALt라는 필드의 데이터를 그룹화 한다.
```

집계를 중첩해서 사용할 수도 있다.

```bash
POST movie/_search
{
	"aggs" : {
		"genre" : {
			"terms" : {
				"field" : "genreAlt"
			},
			"aggs" : {
				"nation" : {
					"terms" : {
					"field" : "nationAlt"
					}
				}
			}
		}
	}
}
#장르별 국가 형태를 중첩해서 보여주는 예다.
```

##### 4.2 데이터 집계 타입

집계 기능은 현재 4가지 API로 제공된다. 집계 기능은 서로 조합해 사용할 수 있으며 이를 조합해서 매우 강력한 기능을 제공할 수 있다.

| 집계 종류       | 특징                                                         |
| --------------- | ------------------------------------------------------------ |
| 버킷 집계       | 집계 중 가장 많이 사용한다. 문서의 필드를 기준으로 버킷을 집계한다. |
| 메트릭 집계     | 문서에서 추출된 값을 가지고 Sum,Max,Min,Avg를 계산한다.      |
| 매트릭스 집계   | 행렬의 값을 합하거나 곱한다.                                 |
| 파이프라인 집계 | 버킷에서 도출된 결과 뭇너를 다른 필드 값으로 재분류한다. 즉 다른 집계에서 생성된 출력 결과를 다시 한번 집계한다. |

