### 1.데이터 모델링

#### 1.1 매핑 API

매핑은 색인 시 데이터가 어디에 어떻게 저장될지를 결정하는 설정이다. 인덱스에 추가되는 각 데이터 타입을 구체적으로 정의하는 일이다.

###### *처음 문자열로 색인된 필드에는 뒤에 숫자가 추가될 수 있다. 하지만 그 반대의 경우 색인에 실패한다.*

매핑 정보를 설정할때는 다음과 같은 사항을 고려해야 한다.

- 문자열을 분석할 것인가?
- _source에 어떤 필드를 정의할 것인가?
- 날짜 필드를 가지는 필드는 무엇인가?
- 매핑에 정의되지 않고 유입되는 필드는 어떻게 처리할 것인가?

##### 1.1.1 매핑 인덱스 만들기

다음은 매핑 인덱스의 기본적인 형태다.

```bash
PUT {index}
{
	"mappings" : {
		"properties" : {
			"field" : {"type" : "필드타입"}
			...<필드 설정>
		}
	}
}
```

매핑 인덱스를 생성한 후 데이터를 색인하는 과정은 다음과 같다.

```bash
PUT {index}/_doc/1
{
	"field1" : "content",
	"field2" : "content2",
	"field3" : "content3",
	
}
```

###### *매핑 인덱스가 정의되고 나면 필드를 삭제하거나 설정값을 변경하는 것은 불가능하다.*

하지만 기존 매핑 인덱스에 필드를 추가로 정의하는 것은 가능하다.

```bash
PUT {index}/_mapping
{
	"properties" : {
		"field" : {
			"type" : "필드 타입"
		}
	}
}
```

##### 1.1.2 매핑 확인

이미 생성된 매핑 인덱스를 확인하려면 _mapping API를 사용할 수 있다. 

```bash
GET {index}/_mapping
```

##### 1.1.3 매핑 파라미터

매핑 파라미터는 색인할 필드의 데이터를 어떻게 저장할지에 대한 다양한 옵션을 제공한다.

analyzer

- 해당 필드의 데이터를 형태소 분석하겠다는 의미의 파라미터다. 별도의 분석기를 지정하지 않으면 Standard Analyzer로 형태소 분석을 수행한다.

normalizer

- term query에 분석기를 사용하기 위해 사용된다. 예를 들어 keyword 데이터 타입의 경우 원문을 기준으로 문서가 색인되기 때문에 cafe,Cafe,CAFE는 서로 다른 문서로 인식된다. 하지만 해당 유형을 normalizer를 통해 분석기에 필터를 사용하면 같은 데이터로 인식되게 할 수 있다.

coerce

- 색인 시 자동 변환을 허용할지 여부를 설정하는 파라미터다. 예를 들어 "10"과 같은 숫자 형태의 문자열이 integer 타입의 필드에 들어온다면 엘라스틱서치는 자동으로 형변환을 수행해서 정상적으로 처리한다. 하지만 coerce 설정을 미사용으로 변경한다면 색인에 실패하게 된다.

copy_to

- 매핑 파라미터를 추가한 필드의 값을 지정한 필드로 복사한다. 

  ```bash
  PUT {index}
  {
  	"mappings" : {
  		"properties" : {
  			"first_name" : {
  				"type" : "keyword",
  				"copy_to" : "full_name"
  			},
  			"last_name" : {
  				"type" : "keyword",
  				"copy_to" : "full_name"
  			},
  			"full_name" : {
  				"type" : "text"
  			}
  		}
  	}
  }
  #이후 인덱스에 값을 넣고 검색해 보면 first_name + last_name이 full_name으로 복사된다.
  ```

  

fieldata

- text 데이터 타입의 필드르 집계해야할 상황에만 쓰인다. 잘 쓰이지 않는다.

doc_values

- ynamic

dynamic

- 매핑에 필드를 추가할 때 동적으로 생성할지, 생성하지 않을지를 결정한다. 동적 생성 필드의 처리 방법으로 다음의 세 가지 설정 중 하나를 지정할 수 있다.

| 인자   | 설명                                                         |
| ------ | ------------------------------------------------------------ |
| true   | 새로 추가되는 필드를 매핑에 추가한다.                        |
| false  | 새로 추가되는 필드를 무시한다. 해당 필드는 색인되지 않아 검색할 수 없지만 _source에는 표시된다. |
| strict | 새로운 필드가 감지되면 예외가 발생하고 문서 자체가 색인되지 않는다. 새로 유입되는 필드는 사용자가 매핑에 명시적으로 추가해야 한다. |



enabled

- 검색 결과에는 포함하지만 색인은 하고 싶지 않은 경우(메타데이터)가 있다. 이때 색인을 원치 않는 필드의 매핑파라미터중 enabled를 false로 설정하면 _source에는 검색 되지만 색인은 하지 않는다.

format

- 엘라스틱서치는 날짜/시간을 문자열로 표시한다. 이때 날짜/시간을 문자열로 변경할 때 미리 구성된 포맷을 사용할 수 있다.

![format표](C:\Users\pop24\Desktop\source_code\image\format표.png)

ignore_above

- 필드에 저장되는 문자열이 지정한 크기를 넘어서면 빈 값으로 색인한다. 지정한 크기만큰 색인되는 것이 아니라 빈 값으로 저장되므로 주의해야 한다.

ignore_malformed

- 잘못된 데이터 타입을 색인하려고 하면 예외가 발생하고 해당 문서 전체가 색인되지 않는다. 이 매핑 파라미터를 사용하면 해당 필드만 무시하고 문서는 색인할 수 있다.

index

- 필드값을 색인할지를 결정한다. 기본값은 true이며, false로 변경하면 해당 필드를 색인하지 않는다.

fields

- 다중 필드를 설정할 수 있다. 필드 안에 또 다른 필드의 정보를 추가할 수 있다. 

  ```
  PUT {index}
  {
  	"mappings" : {
  		"_doc" : {
  			"properties" : {
  				"field1" : {
  					"type" : "필드 타입1",
  					"fields" : {
  						"field2" : {
  							"type" : "필드 타입2"
  						}
  					}
  				}
  			}
  		}
  	}
  }
  ```

  

norms

- 문서의 _score 값 계산에 필요한 정규화 인수를 사용할지 여부를 설정한다. _score 계산이 필요없거나 단순 필터링 용도로 사용하는 필드는 비활성화해서 디스크 공간을 절약할 수 있다.

null_value

- 색인 시 문서에 필드가 없거나 필드의 값이 null이면 색인 시 필드를 생성하지 않는다. 이 경우 null_value를 설정하면 문서의 값이 null이더라도 필드를 생성하고 그에 해당하는 값으로 저장한다.

  ```bash
  PUT {index}
  {
  	"mappings" : {
  		"properties" : {
  			"field" : {
  				"type" : "필드 타입",
  				"null_value" : "0"
  			}
  		}
  	}
  }
  ```

  

position_increment_gap

- 배열 형태의 데이터를 색인할 떄 검색의 정확도를 높이기 위해 제공하는 옵션이다.

properties

- 오브젝트 타입이나 중첩 타입의 스키마를 정의할 때 사용되는 옵션으로 필드의 타입을 매핑한다.

search_analyzer

- 일반적으로는 색인과 검색 시 같은 분석기를 사용한다. 

similarity

- 유사도 측정 알고리즘을 지정한다. 기본 알고리즘인 BM25에서 다른 알고리즘으로 변경할 수 있다.

store

term_vector

위 두개는 이해가 안된다.

#### 1.2 메타 필드

##### 1.2.1 _index 메타 필드

_index 메타필드는 해당 문서가 속한 인덱스의 이름을 담고있다. 이를 이용해 검색된 문서의 인덱스명을 알 수 있으며, 해당 인덱스에 몇 개의 문서가  있는지 확인할 수 있다.

```bash
GET {index}/_search
{
	"size" : 0,
	"aggs" : {
		"indices" : {
			"terms" : {
				"field" : "_index",
				"size" : 10
			}
		}
	}
}
```

##### 1.2.2 _type 메타필드

_type 메타 필드는 해당 문서가 속한 매핑의 타입 정보를 담고 있다. 이를 이용해 해당 인덱스 내부에서 타입별로 몇 개의 문서가 있는지 확인할 수 있다.

```bash
GET {index}/_search
{
	"size" : 0,
	"aggs" : {
		"indices" : {
			"terms" : {
				"field" : "_type",
				"size" : 10
			}
		}
	}
}
```

##### 1.2.3 _id 메타필드

_id 메타 필드는 문서를 식별하는 유일한 키 값이다. 한 인덱스에서 색인된 문서마다 서로 다른 키 값을 가진다. 집계 API를 이용해 다음과 같이 검색 질의를 하면 키 값에 대응하는 모든 문서가 출력된다.

```bash
POST movie_search/_search
{
  "size" : 0,
  "aggs" : {
    "indices" : {
      "terms": {
        "field": "_id",
        "size": 10
      }
    }
  }
}
```

#### 1.3 필드 데이터 타입

##### 1.3.1 keyword 데이터 타입

keyword 데이터 타입은 말 그대로 키워드 형태로 사용할 데이터에 적합한 데이터 타입이다. keyword 타입을 사용할 경우 별도의 분석기를 거치지 않고 원문 그대로 색인하기 때문에 특정 코드나 키워드 등 정형화된 콘텐츠에 주로 사용된다.

keyword 타입은 아래에 해당하는 항목에 많이 사용된다.

- 검색 시 필터링되는 항목
- 정렬이 필요한 항목
- 집계해야 하는 항목

이 세 가지 경우에는 반드시 keyword 타입을 사용해야 한다.

##### 1.3.2 text 데이터 타입

text 데이터 타입을 이용하면 색인 시 지정된 분석기가 칼럼의 데이터를 문자열 데이터로 인식하고 이를 분석한다. 영화의 제목이나 영화의 설명글과 같이 문장 형태의 데이터에 사용하기 적합한 데이터 타입이다. 

text 타입은 전문검색에 적합하지만 간혹 집계나 정렬이 필요한 경우 keyword 타입을 동시에 갖도록 멀티필드로 설정할 수 있다.

```bash
PUT {index}
{
	"mappings" : {
		"properties" : {
			"field1" : {
				"type" : "text",
				"fields" : {
					"field1_keyword" : {
						"type" : "keyword"
					}
				}
			}
		}
	}
}
```

##### 1.3.3 array 데이터 타입

데이터는 대부분 1차원으로 표현되지만 2차원으로 존재하는 경우도 있다. 하나의 필드에 복수의 데이터를 입력하고 싶은 경우 array 타입을 사용한다.

```bash
PUT {index}/_doc/1
{
	"title" : "해리포터와 마법사의 돌",
	"subtitlelang" : ["eng","ko"]
}
```

##### 1.3.4 numeric 데이터 타입

숫자 데이터 타입은 여러 가지 종류가 제공된다. 숫자 데이터 타입이 여러 개 제공되는 이유는 데이터의 크기에 알맞은 타입을 제공함으로써 색인과 검색을 효율적으로 처리하기 위해서다.

![numeric](C:\Users\pop24\Desktop\source_code\image\numeric.png)

##### 1.3.5 date 데이터 타입

date 타입은 JSON 포맷에서 문자열로 처리된다. 날짜는 다양하게 표현될 수 있기 때문에 올바르게 구문 분석될 수 있게 날짜 문자열 형식을 명시적으로 설정해야 한다. 

###### *만약 별도의 형식을 지정하지 않을 경우 기본 형식인 "yyyy-MM-ddTHH:mm:ssZ"로 지정된다.*

date 타입은 다음과 같이 크게 세 가지 형태를 제공한다.

- 문자열이 포함된 날짜 형식 : "2018-04-20","2017/04.20","2018-04-20" 10:50:00","2018/04/20 10:50:00"
- ISO_INSTANT 포맷의 날짜 형식 : "2018-04-19T10:50:00Z"
- 밀리초: 1524449145579

```bash
PUT {index}
{
	"mappings" : {
		"properties" : {
			"field" : {
				"type" : "date","format" : "yyyy-MM-dd HH:mm:ss"
			}
		}
	}
}
```

##### 1.3.6 range 데이터 타입

range 데이터 타입은 범위가 있는 데이터를 저장할 때 사용하는 데이터 타입이다. 만약 데이터의 범위가 10~20의 정수라면 10,11,12,,20 까지의 숫자를 일일이 지정하는 것이 아니라 데이터의 시작과 끝만 정의하면 된다.

다음과 같이 숫자뿐 아니라 IP에 대한 범위도 Range 데이터 타입으로 정의할 수 있다. 

![range](C:\Users\pop24\Desktop\source_code\image\range.png)

range 타입을 사용해 영화의 개봉일부터 종료일까지를 표시할 수 있다.

```bash
PUT movie_search_datatype
{
	"mappings" : {
		"properties" : {
			"showRange" : {
		        "type" : "date_range"
			}
		}
	}
}
```

```bash
#데이터를 입력할 때 showRange 칼럼에 다음과 같이 시작값과 종료값의 범위를 지정해 줄 수 있다.
PUT movie_search_datatype/_doc/2
{
	"showRange" : {
		"gte" : "2001-01-01",
		"lte" : "2001-12-31"
	}
}
```

##### 1.3.7 geo-potint 데이터 타입

위도,경도 등 위치 정보를 담은 데이터를 저장할 때 goe-point 타입을 사용할 수 있다.

```bash
PUT {index}/_doc/1
{
	"title" : "해리포터와 마법사의 돌",
	"filmLocation" : {
		"lat" : 55.4155822,
		"lon" : -1.708191
	}
}
```

##### 1.3.8 ip 데이터 타입

ip 주소와 같은 데이터를 저장하는 데 사용한다. IPv4나 IPv6를 모두 지정할 수 있다.